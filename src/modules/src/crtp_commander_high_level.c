/*
 *    ______
 *   / ____/________ _____  __  ________      ______ __________ ___
 *  / /   / ___/ __ `/_  / / / / / ___/ | /| / / __ `/ ___/ __ `__ \
 * / /___/ /  / /_/ / / /_/ /_/ (__  )| |/ |/ / /_/ / /  / / / / / /
 * \____/_/   \__,_/ /___/\__, /____/ |__/|__/\__,_/_/  /_/ /_/ /_/
 *                       /____/
 *
 * Crazyswarm advanced control firmware for Crazyflie
 *

The MIT License (MIT)

Copyright (c) 2018 Wolfgang Hoenig and James Alan Preiss

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/


/*
High-level commander: computes smooth setpoints based on high-level inputs
such as: take-off, landing, polynomial trajectories.
*/

#include <string.h>
#include <errno.h>
#include <math.h>

/* FreeRtos includes */
#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"

#include "crtp.h"
#include "crtp_commander_high_level.h"
#include "planner.h"
#include "log.h"
#include "param.h"
#include "static_mem.h"
#include "mem.h"
#include "commander.h"
#include "stabilizer_types.h"
#include "stabilizer.h"

#include "debug.h"

// Local types
enum TrajectoryLocation_e {
  TRAJECTORY_LOCATION_INVALID = 0,
  TRAJECTORY_LOCATION_MEM     = 1, // for trajectories that are uploaded dynamically
  // Future features might include trajectories on flash or uSD card
};

struct trajectoryDescription
{
  uint8_t trajectoryLocation; // one of TrajectoryLocation_e
  uint8_t trajectoryType;     // one of TrajectoryType_e
  union
  {
    struct {
      uint32_t offset;  // offset in uploaded memory
      uint8_t n_pieces;
    } __attribute__((packed)) mem; // if trajectoryLocation is TRAJECTORY_LOCATION_MEM
  } trajectoryIdentifier;
} __attribute__((packed));

// allocate memory to store trajectories
// 4k allows us to store 31 poly4d pieces
// other (compressed) formats might be added in the future
#define TRAJECTORY_MEMORY_SIZE 8192

#define ALL_GROUPS 0

// Global variables
uint8_t trajectories_memory[TRAJECTORY_MEMORY_SIZE];
static struct trajectoryDescription trajectory_descriptions[NUM_TRAJECTORY_DEFINITIONS];

// Static structs are zero-initialized, so nullSetpoint corresponds to
// modeDisable for all stab_mode_t members and zero for all physical values.
// In other words, the controller should cut power upon recieving it.
const static setpoint_t nullSetpoint;

static bool isInit = false;
static struct planner planner;
static uint8_t group_mask;
static struct vec pos; // last known setpoint (position [m])
static struct vec vel; // last known setpoint (velocity [m/s])
static float yaw; // last known setpoint yaw (yaw [rad])
static struct piecewise_traj trajectory;
static struct piecewise_traj_compressed  compressed_trajectory;

// makes sure that we don't evaluate the trajectory while it is being changed
static xSemaphoreHandle lockTraj;
static StaticSemaphore_t lockTrajBuffer;

// safe default settings for takeoff and landing velocity
static float defaultTakeoffVelocity = 0.5f;
static float defaultLandingVelocity = 0.5f;

// Trajectory memory handling from the memory module
static uint32_t handleMemGetSize(void) { return crtpCommanderHighLevelTrajectoryMemSize(); }
static bool handleMemRead(const uint32_t memAddr, const uint8_t readLen, uint8_t* buffer);
static bool handleMemWrite(const uint32_t memAddr, const uint8_t writeLen, const uint8_t* buffer);
static const MemoryHandlerDef_t memDef = {
  .type = MEM_TYPE_TRAJ,
  .getSize = handleMemGetSize,
  .read = handleMemRead,
  .write = handleMemWrite,
};

STATIC_MEM_TASK_ALLOC(crtpCommanderHighLevelTask, CMD_HIGH_LEVEL_TASK_STACKSIZE);

// CRTP Packet definitions

// trajectory command (first byte of crtp packet)
enum TrajectoryCommand_e {
  COMMAND_SET_GROUP_MASK          = 0,
  COMMAND_TAKEOFF                 = 1, // Deprecated (removed after August 2023), use COMMAND_TAKEOFF_2
  COMMAND_LAND                    = 2, // Deprecated (removed after August 2023), use COMMAND_LAND_2
  COMMAND_STOP                    = 3,
  COMMAND_GO_TO                   = 4,
  COMMAND_START_TRAJECTORY        = 5,
  COMMAND_DEFINE_TRAJECTORY       = 6,
  COMMAND_TAKEOFF_2               = 7,
  COMMAND_LAND_2                  = 8,
  COMMAND_TAKEOFF_WITH_VELOCITY   = 9,
  COMMAND_LAND_WITH_VELOCITY      = 10,
};

struct data_set_group_mask {
  uint8_t groupMask; // mask for which groups this CF belongs to
} __attribute__((packed));

// vertical takeoff from current x-y position to given height
// Deprecated (removed after August 2023)
struct data_takeoff {
  uint8_t groupMask;        // mask for which CFs this should apply to
  float height;             // m (absolute)
  float duration;           // s (time it should take until target height is reached)
} __attribute__((packed));

// vertical takeoff from current x-y position to given height
struct data_takeoff_2 {
  uint8_t groupMask;        // mask for which CFs this should apply to
  float height;             // m (absolute)
  float yaw;                // rad
  bool useCurrentYaw;       // If true, use the current yaw (ignore the yaw parameter)
  float duration;           // s (time it should take until target height is reached)
} __attribute__((packed));

// vertical takeoff from current x-y position to given height, with prescribed
// velocity
struct data_takeoff_with_velocity {
  uint8_t groupMask;        // mask for which CFs this should apply to
  float height;             // m (absolute or relative)
  bool heightIsRelative;    // If true, height is relative to the current height (positive pointing up)
  float yaw;                // rad
  bool useCurrentYaw;       // If true, use the current yaw (ignore the yaw parameter)
  float velocity;           // m/sec (average velocity during takeoff)
} __attribute__((packed));

// vertical land from current x-y position to given height
// Deprecated (removed after August 2023)
struct data_land {
  uint8_t groupMask;        // mask for which CFs this should apply to
  float height;             // m (absolute)
  float duration;           // s (time it should take until target height is reached)
} __attribute__((packed));

// vertical land from current x-y position to given height
struct data_land_2 {
  uint8_t groupMask;        // mask for which CFs this should apply to
  float height;             // m (absolute)
  float yaw;                // rad
  bool useCurrentYaw;       // If true, use the current yaw (ignore the yaw parameter)
  float duration;           // s (time it should take until target height is reached)
} __attribute__((packed));

// vertical land from current x-y position to given height, with prescribed
// velocity
struct data_land_with_velocity {
  uint8_t groupMask;        // mask for which CFs this should apply to
  float height;             // m (absolute or relative)
  bool heightIsRelative;    // If true, height is relative to the current height (positive pointing down)
  float yaw;                // rad
  bool useCurrentYaw;       // If true, use the current yaw (ignore the yaw parameter)
  float velocity;           // m/s (average velocity during landing)
} __attribute__((packed));

// stops the current trajectory (turns off the motors)
struct data_stop {
  uint8_t groupMask;        // mask for which CFs this should apply to
} __attribute__((packed));

// "take this much time to go here, then hover"
struct data_go_to {
  uint8_t groupMask; // mask for which CFs this should apply to
  uint8_t relative;  // set to true, if position/yaw are relative to current setpoint
  float x; // m
  float y; // m
  float z; // m
  float yaw; // rad
  float duration; // sec
} __attribute__((packed));

// starts executing a specified trajectory
struct data_start_trajectory {
  uint8_t groupMask; // mask for which CFs this should apply to
  uint8_t relative;  // set to true, if trajectory should be shifted to current setpoint
  uint8_t reversed;  // set to true, if trajectory should be executed in reverse
  uint8_t trajectoryId; // id of the trajectory (previously defined by COMMAND_DEFINE_TRAJECTORY)
  float timescale; // time factor; 1 = original speed; >1: slower; <1: faster
} __attribute__((packed));

// starts executing a specified trajectory
struct data_define_trajectory {
  uint8_t trajectoryId;
  struct trajectoryDescription description;
} __attribute__((packed));

// Private functions
static void crtpCommanderHighLevelTask(void * prm);

static int set_group_mask(const struct data_set_group_mask* data);
static int takeoff(const struct data_takeoff* data);
static int land(const struct data_land* data);
static int takeoff2(const struct data_takeoff_2* data);
static int land2(const struct data_land_2* data);
static int takeoff_with_velocity(const struct data_takeoff_with_velocity* data);
static int land_with_velocity(const struct data_land_with_velocity* data);
static int stop(const struct data_stop* data);
static int go_to(const struct data_go_to* data);
static int start_trajectory(const struct data_start_trajectory* data, float offset);
static int define_trajectory(const struct data_define_trajectory* data);

static const int structure[5][2] = {{22, 32}, {22,4}, {32,32}, {32, 32}, {32, 4}};
static float output_residual[4];
static float output_0[32];
static float output_1[32];
static float output_2[32];
static float output_3[4];
static const float residual_layer_weight[22][4] = {{-0.000551158, -0.04675513, -0.0066236584, 0.019684464}, {0.0011531494, 0.0034281858, 0.021290626, -0.0010352413}, {-0.4843183, -0.022067055, -0.053089276, -0.05627491}, {-0.007192088, -0.003823356, -0.027002936, 0.0055201603}, {-0.04181289, -0.10803318, 0.007544131, -0.005745388}, {-0.05734218, -0.058081288, -0.045163076, 0.023291875}, {-0.0077442555, -0.035463855, 0.018036388, -0.052591998}, {0.08100727, 0.054693203, 0.042796824, -0.07119662}, {-0.010480177, 0.043694995, 0.028013527, 0.088086374}, {-0.17858508, 0.13052744, 0.023816008, 0.18879251}, {-0.076746434, 0.13436666, -0.030568775, -0.059661675}, {0.021306474, -0.07297201, -0.05676481, -0.09087397}, {0.937386, -0.019992517, -0.06619991, -0.05924379}, {0.019043908, 0.0064705815, 0.098046884, 0.13271478}, {-0.045778297, 0.06878169, -0.020161103, -0.012822861}, {0.061218657, 0.038436994, 0.06325761, 0.047591645}, {0.022232095, -0.09041089, -0.11917537, -0.097147755}, {0.04132714, -0.05859613, 0.05098532, 0.09380426}, {-0.15267414, -0.078533545, 0.023966014, 0.036861937}, {-0.015048662, 0.025418565, 0.029043853, 0.037999514}, {-0.016550422, 0.016915312, -0.019143661, -0.057089217}, {0.3660568, 0.035735544, 0.0043751793, -0.0368441},};
static const float layer_0_weight[22][32] = {{-0.023678593, -0.178675, 0.16158278, -0.015680011, 0.2782665, 0.46140978, 0.13830177, 0.32621312, -0.3451546, 0.31000423, -0.060739253, 0.34245488, 0.2106968, 0.2296116, 0.34947097, 0.31988826, -0.16315418, -0.46406573, 0.3148255, -0.008543379, -0.20653497, -0.38805667, -0.26471767, 0.045987576, -0.0736312, -0.033326615, 0.120197095, 0.06138811, -0.2682984, -0.20999795, -0.15794632, -0.24929678},
{-0.2688451, -0.32518286, -0.35904768, -0.29201242, -0.17191602, 0.026060235, 0.17989777, -0.121573016, 0.13522466, -0.2932622, -0.33598748, -0.06633007, -0.37553668, 0.069060154, 0.19933388, 0.07356603, -0.20236544, -0.0065669017, 0.08700066, -0.27818623, 0.30007353, 0.30930558, 0.0817184, -0.35111976, -0.37453225, -0.3549446, 0.38627216, 0.15173005, -0.21850215, 0.07041989, 0.27855477, -0.12460216},
{-0.05023293, 0.047884505, -0.06501899, 0.053587496, 0.046449706, 0.2189827, -0.012518985, 0.04901408, 0.34654406, -0.26810238, 0.42346117, -0.13601328, 0.046091028, -0.015457722, 0.1291394, -0.0043938193, -0.11785748, 0.30516586, -0.03648019, -0.049365908, -0.25142965, 0.06315089, -0.034758914, -0.12614939, -0.022877585, 0.2468779, 0.27790314, -0.02258032, -0.13122031, -0.046137225, -0.051558085, -0.000118610085},
{-0.06059665, -0.23563996, 0.03418742, 0.00038736893, 0.35994032, -1.0166936, 0.07377229, -0.0050641946, -0.53344446, -0.88891935, -0.14000058, -0.2746283, 1.2575928, 0.061668932, 0.95431626, -0.24866502, 0.05283528, 0.22897112, 0.21196322, -0.042146273, -0.26095733, 0.09033688, 0.82443666, -0.24063884, -0.748404, -0.021710169, -0.43762702, -0.034751546, 0.060116734, 0.65030503, -0.10690193, 0.058557685},
{1.1279098, -0.28240013, -0.066823006, 0.059145615, -2.2485163, -0.5616677, 0.0027736903, -0.32651225, -0.10421047, -1.6919217, 0.010907014, 0.8362695, 0.19366558, -0.22479486, -0.67759776, 0.13247508, 0.14524642, -0.16516916, 0.27171397, 0.049483415, -0.08891819, -0.3567272, -0.083265424, -1.9271045, 0.6533551, 0.06420691, 0.12567288, 0.37078312, 0.109244, -1.4098672, -0.30383387, 0.13822487},
{-1.7962092, 1.1214312, 0.18273397, -0.73212624, 1.0323747, 1.2821324, 0.09253094, -0.05731789, -0.69938344, -0.87143433, 0.65395826, -0.66723317, 1.0319346, -0.0046080453, -0.56894106, -0.84338504, -0.19832282, 0.3204182, -0.16005932, -0.06408565, 1.3883107, 0.15585278, -1.7575178, -1.2881464, 1.2318214, -0.092899755, -0.5008678, -0.13057593, -1.1593258, 0.3903605, -0.023232788, 0.49223128},
{0.6856117, 1.1489428, -0.012819941, -0.33882004, -0.65700626, 0.25752908, -0.0056258882, 0.019784873, 0.58908963, -0.2770372, 0.2643137, 0.5409484, 0.616354, 0.009922273, 0.07972698, 1.001049, -0.019787068, -0.30702618, -0.012065736, 0.14555155, 0.98083335, -0.033903643, 0.80926466, 0.78694504, -0.30649993, 0.0024114102, 0.38853094, 0.21370462, -0.14016093, 1.0013485, 0.056000657, 0.09258695},
{-0.062215418, 0.1494978, 0.3269038, 0.2987301, -0.3536812, -0.24187654, -0.16163488, 0.018179877, -0.034351792, -0.4306889, -0.21072108, -0.054383025, -0.22079884, 0.24536844, -0.271306, -0.26944014, -0.5402049, 0.014432579, 0.20972879, -0.29954836, 0.012213044, -0.5426872, 0.21892808, -0.036383722, 0.15677695, 0.109809645, -0.26875874, 0.4785456, 0.03749976, 0.117728956, -0.10566577, -0.23628733},
{0.48578218, 0.2729088, -0.19768658, 0.14781563, 0.1491016, -0.16876027, 0.600252, -0.4209556, 0.18639159, 0.17950645, -0.07730383, 0.29699418, 0.3229618, -0.32439098, -0.07233359, -0.047374237, 0.18016765, 0.57004106, -0.007882656, -0.33025563, -0.33886692, -0.20844369, -0.082385086, 0.24327259, 0.10492307, -0.38413885, -0.24924068, 0.105319686, -0.019783005, 0.0454607, 0.20031588, -0.38690838},
{-0.10668943, -0.006950593, 0.05004639, 0.49333525, -0.2586652, 0.20727366, -0.051811304, 0.16462566, -0.033436988, 0.006600293, -0.10325308, -0.13566457, 0.1479841, -0.060627125, 0.10296538, 0.25090048, -0.25061065, 0.31061456, 0.21455866, 0.071650185, 0.026909707, -0.14256693, 0.045074932, 0.111443095, 0.15706785, 0.031565145, -0.21308325, 0.11513313, -0.06922116, 0.011786819, 0.29063344, 0.44458604},
{-0.23660919, 0.09741826, -0.27286673, 0.12219068, -0.15909646, -0.59694177, 0.44396812, 0.24234448, 0.21190967, -0.26022282, 0.17187896, -0.11026461, -0.2171389, 0.022827467, -0.47185317, -0.42866254, 0.0026577371, 0.009760325, 0.28097975, 0.34477007, 0.048132386, 0.0736309, 0.212261, 0.030647658, 0.021085188, -0.12734897, -0.03981468, -0.16411662, -0.3183276, 0.15180455, -0.5256586, -0.21725987},
{0.031563986, 0.28653693, -0.14231974, 0.119543105, 0.30017698, 0.083725765, -0.007149145, 0.22621758, -0.032596312, 0.25781572, 0.044163454, 0.041342374, 0.36466795, 0.3174514, -0.34080753, -0.26877466, -0.2264541, -0.28204978, -0.4594711, -0.23643513, -0.30997625, 0.32072395, -0.0063292854, 0.43142337, 0.4374785, -0.10225379, -0.38757685, 0.35108444, 0.3970796, -0.20122541, -0.09052477, 0.24434274},
{0.12771627, -0.012578125, 0.015580611, 0.15711719, -0.0022644002, -0.18520099, -0.016755674, 0.31596997, -0.018430429, 0.0030045172, -0.066574775, -0.13588144, -0.11734264, -0.08177889, -0.0065451018, -0.05001285, -0.06533972, -0.10995329, 0.22665134, 0.063529, -0.032214966, 0.12854947, -0.06971063, -0.14195114, 0.031358197, -0.09028809, -0.107994914, -0.20930727, -0.056434985, -0.03372225, 0.0819604, 0.0040148143},
{0.2541106, -0.008419317, -0.548897, -0.13722217, -0.10667336, 0.10282766, 0.64496773, 0.1710693, -0.07979374, -0.0020315899, 0.34058973, 0.2787048, -0.055397958, -0.038650554, -0.0042916466, -0.11818444, 0.37494212, -0.21426252, -0.07907011, 0.62726086, 0.06810488, 0.42164093, -0.03441642, -0.14166412, -0.04237859, -0.46068117, 0.07647387, -0.534405, -0.27348152, 0.18437171, -0.33275247, -0.15571581},
{0.059112865, 0.10143858, -0.18934321, -0.10452558, -0.07015723, 0.12395164, -0.18052207, 0.5350362, -0.10512325, -0.04407837, -0.019882489, 0.10176495, 0.006925205, 0.6068649, -0.00038607404, 0.040355116, -0.52650034, -0.13577135, -0.4501011, -0.011938351, 0.17314209, 0.28649926, -0.06762864, -0.05716394, -0.010796557, 0.044632643, 0.024137814, 0.21962805, 0.5233764, 0.045802474, -0.41309813, 0.60878134},
{0.084631465, -0.022442233, 0.19242588, -0.12528212, 0.06256808, -0.22363292, 0.10954337, -0.043546923, -0.13630646, 0.08167207, -0.032992948, 0.17946604, -0.0011989146, -0.1759621, -0.14981031, 0.03214852, -0.036523897, 0.07974055, 0.0060422495, 0.15498896, 0.19214849, -0.1885169, 0.03013131, 0.17642114, -0.0506105, -0.12941009, -0.11625085, -0.1545213, -0.09790319, 0.06444191, -0.009521136, -0.10706668},
{-0.010025446, -0.039291248, -0.24618432, -0.2219336, 0.10050383, 0.17331389, 0.19210002, 0.26077196, 0.04602724, 0.072671585, 0.12761332, -0.115678035, 0.18125737, -0.21865366, 0.08401891, 0.064877294, 0.35783428, 0.25570798, -0.15228267, 0.2214833, -0.054448035, 0.26029587, -0.07618857, 0.039248224, 0.0729652, -0.2551271, 0.034490533, -0.32156548, -0.14460386, -0.1412146, -0.25423142, 0.17944984},
{-0.17984317, -0.08060332, -0.071290195, 0.029854897, 0.026317036, -0.082145214, -0.21895073, 0.3098771, -0.14438616, -0.033065178, 0.11759171, 0.0642979, -0.07092703, 0.25235716, 0.07868584, 0.046671383, -0.20977795, -0.34705913, -0.2992015, 0.066597655, 0.09490907, 0.20677306, -0.07905881, -0.06468603, -0.026350116, 0.23498362, 0.005409052, -0.21239154, 0.15619455, -0.0015036435, -0.25881773, 0.2629269},
{-0.07074134, -0.031444214, -0.0007488718, -0.16122735, -0.004003857, 0.07799455, 0.056525145, -0.25666714, -0.13554943, 0.09497589, -0.07125586, -0.09549395, 0.049982663, 0.10731004, 0.036611445, -0.007986404, 0.27347186, -0.2638395, 0.02483434, -0.1505695, -0.018705592, -0.08615864, 0.05707492, -0.024505932, -0.030601138, -0.15153651, 0.06662224, 0.08069463, 0.109937854, -0.025702534, 0.009184732, -0.15618609},
{0.06408378, 0.070436485, 0.13555983, 0.16597073, -0.08093946, -0.24825668, -0.3422089, -0.42207187, 0.17071241, -0.044359826, -0.13709433, -0.17732684, -0.072038956, -0.13839832, -0.07539319, -0.028655367, -0.02725981, 0.27396932, -0.016213836, -0.23577885, 0.11763977, -0.012124825, 0.14585678, 0.039619647, -0.004691842, 0.3143404, -0.029674945, 0.38514367, 0.19713265, 0.07628849, 0.2627477, 0.19957218},
{0.18188578, 0.054863088, 0.2979868, 0.06634516, 0.022414638, -0.0051583857, -0.034973428, -0.08555442, 0.03252052, 0.07522768, 0.31121665, -0.1352118, 0.11405932, -0.36836183, -0.056338366, -0.027322806, 0.41365162, 0.17315543, 0.35003683, 0.24851225, -0.10579119, -0.2864314, 0.013010255, 0.074468456, 0.0751141, 0.09405714, -0.03179211, -0.29275736, -0.18813987, -0.0139124105, 0.13844535, -0.21458864},
{0.021388361, 0.025066782, -0.10075244, 0.030950576, -0.014525048, -0.048507, -0.0962652, 0.024126561, -0.033543047, 0.060112797, -0.15862264, 0.13831082, -0.051022656, 0.11819494, -0.046593215, -0.03756927, -0.015846718, -0.08401762, -0.09483157, 0.019888297, 0.07420441, 0.10938874, -0.021884205, 0.0317663, 0.031918805, 0.04181609, -0.054501828, 0.06499277, 0.10993587, 0.034477886, -0.028358616, 0.13001408},};
static const float layer_1_weight[32][32] = {{-0.47541708, 0.13635111, 0.12050173, 0.20496663, -0.39315817, -0.0031704786, 0.09428305, -0.1030136, 0.086458154, 0.09991434, 0.25035104, 0.615774, -0.12428801, 0.08640258, 0.16211194, -0.89770097, -0.32060713, -0.36687616, -0.3025589, 0.16213275, 0.24151804, -0.35884485, -0.15611939, 0.07213209, 0.11749456, 0.24287915, -0.005958255, -0.26106378, 0.011807035, -0.26742277, 0.27382118, -0.105621904},
{0.15445335, -0.051388983, 0.20683424, 0.5356806, -0.35078683, 0.11601073, 0.24264205, -0.3151931, 0.17287701, 0.05867578, 0.53968865, -0.5382027, -0.3930656, 0.11474637, -0.056452356, 0.20761749, -0.009344272, 0.049650688, -0.5028261, -0.14710455, -0.10714341, -0.28208482, -0.29566363, -0.54853356, 0.32873365, -0.6177825, 0.34838873, 0.46917608, 0.17392613, -0.08249965, -0.08035268, -0.13672392},
{-0.04541403, -0.43944162, -0.30893436, 0.1972002, 0.007917434, -0.25922027, -0.15922874, -0.38719743, 0.0669548, 0.18531251, 0.09956092, 0.057294294, -0.12214172, 0.0050706626, -0.19772948, 0.101410545, 0.12964217, 0.30221015, 0.2008249, 0.15640104, 0.07624922, -0.0054967036, 0.10708242, 0.062406003, 0.16595851, -0.1785808, 0.13282518, -0.20593409, 0.07295269, 0.4182896, -0.36364704, -0.13311823},
{0.010836176, -0.32906067, -0.108269, -0.11021567, 0.43158445, -0.09987749, 0.18296823, -0.30420104, 0.27988765, -0.06023905, -0.054975905, 0.19914457, -0.077022955, -0.042642716, 0.33110175, -0.08318356, 0.19527945, -0.13518304, 0.2479427, 0.1376336, 0.028806828, -0.02929921, -0.012821521, 0.22258328, 0.12627074, 0.37364647, 0.08670747, 0.12621391, -0.18985122, 0.08507059, -0.2067591, -0.15542656},
{-0.34096354, -0.63497245, -0.09243993, -0.072859034, 0.013028977, 0.38997725, -0.08963231, 0.17773916, 0.16303846, -0.18009615, 0.32131472, -0.067898564, 0.40462753, 0.290159, 0.25103617, -0.30785793, -0.3063562, 0.1741346, -0.32544103, 0.06499322, 0.74243736, 0.16028902, -0.48865515, -0.804579, 0.4238293, -0.13853619, -0.5792938, -0.16980451, -0.41321048, 0.07871428, 0.29308137, 0.43641946},
{-0.32900545, -0.1519647, -0.07592389, 0.1588546, -0.16952613, 0.065104134, 0.2688542, 0.04883511, 0.014583859, 0.14301242, 0.3942139, 0.4711542, -0.07651459, -0.08077713, 0.02290304, -0.13076326, -0.04535812, 0.20157062, 0.19971159, -0.32066366, 0.21302171, -0.38654163, 0.27639553, -0.13335876, -0.23348743, -0.47682428, 0.25953788, 0.36585268, -0.12915549, -0.1558055, 0.19373325, 0.15831889},
{-0.053300835, -0.24201432, -0.24102262, -0.030044764, 0.066072635, 0.067193925, 0.03247737, 0.046543647, -0.038649186, 0.4598155, -0.15848905, -0.035145905, -0.047984924, 0.18393673, 0.09422201, 0.2511919, -0.3432592, 0.44227454, 0.0014946851, -0.037077755, -0.33439437, -0.07737966, -0.045945328, 0.19166662, 0.0129016135, -0.4166238, 0.4226664, -0.18059854, -0.087670654, 0.4530184, -0.36346996, 0.07149707},
{0.117645666, 0.3190546, 0.10505058, 0.004704785, 0.246789, -0.124687366, -0.056617428, -0.19090603, 0.014692066, -0.52381086, -0.003946564, 0.031377014, 0.42687452, -0.01406167, -0.065847486, -0.09621342, 0.037980895, -0.020122077, -0.08454772, 0.08896031, -0.14275329, -0.13243769, -0.008601082, -0.13910718, 0.061480436, 0.07433679, -0.0012539463, -0.08926333, 0.0013172441, -0.374633, 0.2788293, 0.10068024},
{0.4206792, 0.00398088, -0.12680437, 0.52258617, -0.32847983, 0.09897078, -0.2853347, 0.07201563, -0.03488696, -0.15313128, -0.14124449, -0.11748384, -0.04538734, 0.3700732, -0.6232396, -0.22494115, 0.17078085, -0.03564818, -0.11652033, -0.39800602, -0.11154924, 0.10103538, -0.09295201, 0.04973454, -0.23609646, -0.0009908986, 0.01557733, -0.4068457, 0.026527647, -0.038101576, -0.3708563, -0.15224338},
{0.025874477, -0.2399921, -0.22827451, 0.36509115, -0.45214885, 0.1596263, 0.29310915, -0.09748214, 0.36149207, -0.09120993, 0.20925501, 0.36495164, 0.18448947, -0.064434886, 0.32828903, -0.41195342, 0.64150494, -0.17477275, 0.25658685, -0.26909173, -0.4702966, 0.102965154, -0.32480475, 0.33714738, -0.40151736, -0.5746886, 0.2544077, -0.38411942, 0.03218736, 0.18309769, -0.18466614, -0.08746581},
{0.16585886, 0.24435876, 0.00790004, 0.28665432, 0.11042533, -0.09881787, 0.13298407, -0.3467959, 0.2702968, -0.03005492, 0.19979267, -0.09605156, 0.21756773, -0.006227004, 0.16973928, -0.15660337, -0.19286396, 0.085275665, 0.1020026, 0.10251122, 0.0870224, -0.37725446, -0.04672609, -0.33624965, -0.071372636, -0.20970367, 0.040326748, 0.4066777, 0.11438968, -0.21248123, 0.14687306, -0.034278233},
{-0.25298646, 0.061437875, 0.16964851, 0.12566559, -0.13570008, 0.036773626, -0.29941308, -0.34359583, -0.35477462, 0.17833778, 0.23578638, -0.07797942, 0.041147385, -0.31561685, -0.111154094, 0.039351806, -0.43057922, 0.328304, 0.22071664, -0.11043233, 0.06495568, -0.5423723, 0.2858749, 0.14482324, 0.5386301, 0.3589038, 0.060684104, 0.28538817, -0.10618966, 0.011621257, -0.23263791, -0.16141203},
{0.17365319, 0.0450633, 0.00062697264, -0.5804691, 0.5077204, -0.14760344, -0.41308036, 0.2575176, -0.18474835, -0.09238244, -0.12624519, 0.37592068, -0.083506495, -0.5561012, 0.055783905, 0.3497804, -0.20875928, 0.12098406, 0.644208, 0.6288587, 0.50745195, 0.01596842, -0.04108125, 0.03603602, -0.034738127, -0.10170645, -0.022558946, 0.31179008, -0.6380482, 0.10368282, 0.13801166, 0.009747199},
{0.1823225, 0.33236304, 0.28608072, 0.108453706, -0.04053336, -0.37682036, 0.117522165, 0.10537916, 0.028194018, -0.38033593, -0.1286683, -0.016373118, 0.30519804, 0.19924323, -0.24708913, -0.19305412, 0.20356674, -0.29060507, 0.041371044, -0.10399115, -0.17901315, 0.0601368, -0.14984053, -0.30721152, -0.09750247, 0.17225926, -0.052435864, -0.041146934, 0.14836757, -0.4915859, 0.2629311, 0.27904412},
{0.17119221, -0.3695468, 0.14008163, -0.085169055, 0.2302724, -0.24638666, -0.32280284, 0.45466202, -0.23827831, 0.06927426, -0.29480502, -0.25841945, 0.031080678, 0.55817145, -0.054053146, 0.19308154, -0.091564216, -0.33096156, -0.25845328, -0.20996729, 0.08490534, 0.5127762, -0.47357944, -0.22517924, 0.007358068, -0.0029928503, -0.24893071, -0.35133654, -0.3114606, 0.1371788, 0.040220257, 0.3437171},
{-0.10311683, -0.029633975, 0.23705086, -0.21678899, 0.039651893, 0.043160487, -0.5002511, -0.05464275, -0.25894356, 0.06664553, 0.16249773, 0.049729858, 0.13776736, -0.3786378, -0.3210966, 0.04579406, -0.25198072, 0.10775652, 0.22341706, 0.11887165, 0.044916365, -0.37816784, 0.363915, -0.33415332, 0.46944144, 0.122949414, 0.21461315, 0.36220247, 0.038916864, -0.16636144, 0.006275077, -0.012419124},
{0.027956083, 0.36255968, 0.3527857, 0.08004128, 0.26053444, -0.61253214, 0.19011204, -0.29236662, 0.039993305, -0.46698818, 0.099200055, -0.08568692, 0.28392938, -0.14023027, -0.07948758, 0.029115323, -0.025832156, -0.24521378, 0.014475147, 0.04864798, -0.057505123, -0.0070848987, -0.029558416, 0.16294429, 0.27324268, -0.31538692, -0.042222254, -0.2796333, -0.16780978, -0.24030082, 0.2526994, 0.003926782},
{-0.11487905, 0.029728372, 0.14875138, -0.21850812, 0.37101993, -0.3453492, 0.18556526, -0.3239674, 0.11983162, -0.181829, -0.18776266, -0.19588107, 0.041246604, -0.04608053, 0.09448157, 0.21859051, -0.0076051736, -0.4121001, 0.0906885, -0.26136354, -0.14155804, 0.003477405, 0.032517623, -0.28522742, -0.11251678, -0.27023223, -0.17681152, 0.24547623, 0.25375378, -0.07514419, 0.51571625, 0.06441812},
{-0.16543023, -0.056978364, 0.01577227, -0.101288676, 0.3195219, 0.049166504, -0.24493836, 0.07733399, -0.25073346, 0.08627677, -0.051262986, -0.26954076, 0.0664334, 0.19612545, -0.13166746, 0.3166357, -0.08578379, 0.16158879, 0.2550456, -0.00783993, -0.27688816, 0.0040221587, -0.16639493, 0.29837766, 0.21393435, -0.11106126, 0.20563963, 0.0016280354, 0.010002797, 0.44605452, -0.34060338, -0.1876808},
{0.14925927, 0.38662457, 0.35177615, 0.13519962, -0.012464082, -0.5103983, 0.0037197126, -0.3754603, 0.05682529, -0.30852118, 0.038162254, -0.015086301, 0.10649025, -0.12668674, -0.105989434, -0.039338723, 0.15092568, -0.44040743, -0.15279207, -0.0047088964, 0.117201604, -0.0418173, -0.10804238, -0.099175, 0.16716763, -0.16719064, -0.06406973, -0.19107544, 0.0984187, -0.3448665, 0.33163497, 0.027563535},
{0.12246671, 0.2875671, 0.025835844, 0.06019256, -0.19940722, 0.18529417, -0.43420255, 0.06368905, -0.20538197, -0.2471918, -0.026275491, -0.50427246, -0.13632774, 0.12785384, -0.47801447, 0.3607442, -0.09429584, 0.07116615, -0.2329341, -0.17247014, 0.14136383, 0.019243212, -0.11063787, -0.019846903, 0.36269167, -0.6822457, -0.084028415, -0.4914377, -0.33277342, 0.11307336, -0.017984902, 0.24380666},
{-0.27410802, -0.102108985, -0.34039187, -0.1758641, 0.2936615, -0.058522515, 0.15779525, -0.04256518, -0.19772054, 0.51813275, -0.09164824, 0.13327517, -0.012912229, -0.097211726, 0.105020136, 0.20137747, -0.34068492, 0.26363295, -0.04901219, -0.06942291, -0.22005826, 0.059016746, -0.0426701, -0.007575911, -0.15676296, 0.01755778, 0.33304432, -0.07835568, 0.10677867, 0.35597354, -0.26295158, -0.26786175},
{-0.4823907, 0.04412379, 0.07590269, 0.4892376, -0.20396459, 0.2826499, 0.028747099, -0.43263215, 0.19356614, 0.3784801, 0.3202504, -0.14759976, -0.29266316, -0.5284, 0.28464702, -0.30413124, -0.1436992, -0.19107242, -0.12427962, 0.27423877, 0.120918475, -0.049302585, -0.5757603, -0.09379912, -0.17241046, 0.4046751, -0.06413807, 0.94348794, -0.25004932, -0.20078674, 0.10243479, 0.18804125},
{0.44559953, -0.006740733, 0.08517978, 0.43243334, -0.030912943, -0.16593258, 0.059886035, -0.20091736, 0.16999792, 0.25654474, 0.33104384, -0.41424966, 0.36470765, -0.47549102, 0.117477596, 0.09682546, 0.1681462, -0.16187426, 0.12565528, 0.34430033, -0.78868973, -0.39412352, 0.37404352, -0.54601175, -0.5642864, 0.6705659, -0.02548083, 0.3553211, 0.4585443, 0.16307044, -0.449419, -0.84574866},
{0.13468452, -0.06987738, -0.5521501, 0.29381165, -0.18199691, 0.010715637, 0.09706046, 0.3501869, 0.48309565, 0.073278345, -0.4773659, -0.30820087, -0.10337646, 0.16255711, -0.16747272, -0.320847, -0.22966217, 0.042321425, 0.060825016, -0.18315613, 0.36325344, 0.4557057, -0.26357502, -0.34094283, -0.17849858, -0.5459499, -0.2584906, -0.3908625, -0.21918264, -0.0037571583, 0.31406364, 0.20839141},
{-0.014741254, -0.19471203, -0.066632524, 0.053897325, 0.34258473, -0.13479479, 0.14747526, 0.06682173, 0.24141449, 0.2459434, 0.051443834, 0.06910408, 0.055671405, 0.08636408, 0.19479235, 0.21142156, -0.011256535, 0.32549277, 0.31321716, 0.19694625, -0.004335026, -0.04736148, 0.041520488, 0.078120805, -0.039740823, -0.16538347, -0.07116125, -0.14024726, 0.14023636, 0.33220515, -0.12528989, -0.12236634},
{0.124425605, 0.05588345, -0.014380956, -0.34774545, -0.06383293, 0.17365205, -0.16651325, 0.17812873, -0.005332519, -0.039834093, -0.021209564, -0.06075819, 0.032894913, 0.04743249, -0.42046273, -0.07496316, -0.49541056, 0.12368487, 0.21010016, -0.34841225, 0.055503204, -0.16040206, 0.37806043, -0.091691375, 0.2652942, 0.50480753, 0.35053852, -0.049552463, -0.25502253, 0.12330912, -0.0787284, 0.18659101},
{0.012000947, 0.31091887, 0.13209194, -0.07021508, -0.06154556, -0.046104334, -0.02287437, -0.029435186, -0.104794756, -0.28314567, -0.11841126, -0.059215344, 0.39202926, 0.103032306, -0.06946357, -0.114534594, 0.31277707, -0.5093527, -0.0802218, -0.00895437, 0.025932675, -0.17266731, -0.06439977, 0.20870881, 0.27072296, 0.04547885, -0.044610474, 0.084511146, -0.23227544, -0.5182695, 0.20098229, 0.11360882},
{0.01307951, 0.07628073, -0.17452593, -0.16793852, -0.013690233, -0.65195984, 0.20262274, -0.18571998, -0.22670917, 0.19350134, -0.05378649, -0.038893137, 0.2632101, -0.18468851, 0.2642785, -0.0036903643, 0.0045321835, 0.24153145, 0.26622537, 0.0045152423, 0.023778934, -0.15285523, 0.18648528, 0.41565257, -0.16818523, 0.3266173, -0.009178459, -0.047233276, 0.022885364, 0.047890928, -0.11800703, -0.22202972},
{0.7771019, -0.13458343, -0.63123924, 0.020553002, -0.7024674, -0.14473811, -0.5763403, -0.28682402, 0.6840842, 0.16629161, -0.756039, -0.4240038, -0.2049232, -0.43122146, 0.2444069, 0.15294248, -0.12110233, -0.13062443, -0.049741592, 0.30010676, -0.752803, 0.07450264, -0.6879606, -0.52407247, -0.24700834, -0.09505343, -0.59086597, 0.1361115, -0.5269086, -0.09440935, -0.027331913, -0.3393871},
{-0.054678887, 0.33581468, -0.11407669, -0.09365133, 0.029908357, -0.22571856, 0.07381326, 0.22095934, -0.05776719, -0.27435306, 0.16373464, -0.10939484, 0.258491, 0.09114073, -0.027578156, -0.010184952, 0.14385605, -0.33888477, -0.10020756, -0.023813067, -0.0539376, 0.037599437, -0.011217453, -0.19549277, 0.11887086, -0.071937725, -0.04893481, 0.10707729, 0.015798805, -0.38767922, 0.28570694, 0.2804066},
{-0.099677354, -0.14904533, -0.40117598, 0.15539058, 0.12193613, -0.0069959755, 0.13610145, -0.25594124, 0.056211505, 0.19618376, 0.13880967, 0.1374344, -0.2247288, 0.021048333, -0.08087237, 0.087024696, -0.049671836, 0.49756366, 0.17038563, -0.0029193363, -0.06821199, -0.022245057, 0.07098946, -0.1171593, -0.073847, -0.6455173, 0.14788386, 0.07485029, 0.1213776, 0.42129275, -0.049123317, -0.05834706},};
static const float layer_2_weight[32][32] = {{0.526287, -0.30219513, -0.1484728, -0.7217223, 0.4616123, 0.30756924, -0.31058085, -0.33568725, -0.58786595, 0.048248664, -0.78580475, -0.07503533, -0.14545883, -0.33913743, 0.75974953, 0.14379133, -0.61156327, -0.27960268, 0.13751101, 0.61492634, 0.7341353, -0.15860523, 0.65014255, 0.043034397, 0.0022064869, 0.4735692, -0.659572, -0.37056315, -0.05067982, 0.72328335, -0.50440735, -0.04323705},
{0.119480915, -0.1741658, -0.08104386, 0.26021987, 0.22840083, -0.06840553, 0.29904443, 0.09165375, -0.108045936, -0.057404567, -0.28838274, -0.38564453, 0.2637616, 0.024235575, -0.27840436, -0.09916275, -0.19346297, -0.35307887, 0.22067021, 0.10581335, 0.08811556, -0.24160601, 0.0038390944, -0.20286697, -0.09657216, 0.5336066, 0.12435449, -0.5298733, -0.21768467, 0.86520624, 0.12761024, -0.02784455},
{-0.025629688, 0.06015672, 0.083743356, 0.14800218, -0.08007637, 0.092418775, -0.14271447, 0.24193513, 0.3125724, 0.041745972, 0.18570893, -0.56670046, 0.39809015, 0.33837515, -0.40151554, 0.074773766, 0.010101638, -0.1409163, 0.053769983, 0.40493196, 0.45472643, 0.09375648, -0.18523751, -0.49870443, 0.036022425, 0.119294025, -0.31717572, -0.16494831, -0.046884708, 0.83671826, -0.09335122, 0.0059755878},
{-0.28317708, 0.25496212, 0.3904776, -0.13255036, -0.47461742, -0.21325982, -0.2746743, 0.26750064, 0.07052802, 0.22181985, 0.43974108, 0.068039976, 0.12197522, -0.15877558, -0.2565156, 0.1526931, 0.4773902, 0.036931016, -0.6798624, -0.20794913, 0.12150776, 0.27050504, -0.4041659, 0.10645309, 0.38478705, 0.20629573, 0.27248096, 0.35359505, -0.4736382, -0.08125888, -0.083723634, 0.41364336},
{-0.047233347, -0.34801248, -0.04011484, 0.14145508, -0.2739354, -0.06907711, 0.09014436, 0.16911796, 0.13251334, -0.20043108, -0.02942848, 0.21679135, 0.050709095, -0.077298865, -0.06380628, 0.14378627, 0.01971926, 0.09116036, -0.10641887, -0.25149077, -0.1552747, -0.020317733, 0.068843886, -0.4257085, 0.03024478, 0.061217632, -0.04352212, -0.19064231, 0.12730527, 0.017452644, 0.09867473, 0.49656603},
{0.24516393, -0.0667426, -0.14448465, 0.24961159, 0.01724519, -0.10446025, -0.11394729, 0.08522302, 0.02475012, -0.14798088, 0.027222997, 0.24209943, 0.14065298, 0.019566886, 0.34029672, -0.16747521, 0.11060571, 0.00046942834, 0.24097559, 0.15687746, 0.20685126, -0.023854053, -0.14596157, -0.16763073, -0.14602555, -0.1565342, 0.3362297, 0.4423241, -0.12606183, -0.35334644, -0.3507883, -0.2437001},
{-0.25217348, -0.09892045, 0.033078298, 0.368544, 0.1342779, 0.26607576, -0.32258576, -0.45429265, -0.3631983, -0.12280153, 0.2564721, -0.24002218, -0.3681581, 0.24270043, -0.20439717, 0.24426612, -0.21635243, 0.07292662, 0.09302247, 0.09731478, 0.11343081, -0.22986524, 0.049503323, -0.2508576, -0.28657955, -0.2164372, -0.24856725, 0.39675003, 0.2921667, 0.2633191, -0.19746497, -0.4874523},
{0.19631907, 0.12806937, 0.024450544, -0.10869041, 0.10906232, 0.33274183, -0.091297485, 0.022407213, -0.10298133, -0.037979513, -0.38313574, -0.06397634, 0.24494608, -0.19899678, 0.30728623, -0.122735545, -0.2704708, -0.17405513, 0.13375553, -0.06764361, -0.020792793, 0.079109885, 0.13579293, 0.027286582, 0.18945509, -0.3564666, -0.09723597, -0.044049054, -0.2389738, 0.18612257, 0.0919111, 0.008452277},
{-0.08610061, -0.004036261, -0.42489484, 0.13570866, -0.021016158, 0.07119029, 0.074179575, -0.79307926, -0.55468893, -0.19635932, -0.043308284, 0.15538542, -0.0841966, 0.18387672, 0.20229281, -0.3051114, -0.07686321, 0.124849975, 0.25425622, -0.029587928, 0.28894335, -0.040974796, -0.2892459, 0.08303386, 0.06851206, -0.23251419, 0.14247304, 0.080388, -0.3237143, 0.105310485, 0.009514446, -0.100593574},
{0.3938812, -0.012180822, 0.011922669, -0.19194712, -0.08637114, -0.34922868, 0.038212694, -0.29903427, -0.27926144, 0.30853242, -0.13108757, 0.97906876, -0.26595962, -0.31266817, 0.20341815, -0.06495879, 0.2650814, 0.07950788, -0.035088293, -0.6711951, -0.42189008, 0.3365903, -0.18461818, 0.44601443, 0.043963566, 0.1276405, 0.20466043, 0.37158027, -0.35963786, -1.8536389, 0.2524878, 0.034815226},
{-0.3906134, -0.023556512, 0.30394706, 0.29860994, -0.22349924, -0.17390224, -0.25468007, -0.00864874, 0.04755155, -0.05376145, 0.42091778, -0.13813718, -0.0068381643, 0.46860597, -0.33347124, 0.28678125, 0.123220764, 0.014163071, 0.019461697, 0.15896855, 0.22507094, -0.05040733, -0.36636025, -0.18104835, -0.35203102, 0.28676245, -0.073121265, 0.29382676, 0.4012411, 0.009127609, -0.07073513, 0.11075744},
{0.041656718, -0.058134343, -0.19784889, 0.28934452, 0.21784161, 0.42683408, -0.20374027, -0.06073086, -0.10844519, -0.33410275, -0.07827098, -0.20745905, -0.12076208, 0.2244735, 0.27134293, 0.15864713, -0.2232536, -0.0058646686, 0.40375727, 0.20955913, 0.02845348, -0.027370516, -0.21858568, -0.12772983, -0.383299, -0.32542104, -0.27889517, 0.057877917, 0.20216876, 0.19184184, 0.06725569, -0.41567662},
{-0.045329265, -0.021841286, 0.2743866, 0.0024865314, 0.15155631, 0.16534388, -0.017876836, 0.624936, -0.1313056, 0.0782896, -0.3302111, -0.12027661, 0.5021237, 0.18610704, 0.12696512, -0.3468504, -0.08583079, 0.18662143, 0.13507217, -0.44852883, -0.15391849, -0.066747144, 0.5134017, 0.1075257, 0.31217098, -0.42962086, -0.17724156, -0.3445055, 0.17266725, 0.6994454, -0.28810334, -0.0046695145},
{-0.23245634, -0.05385188, 0.23420472, -0.20018212, -0.35714024, -0.08960507, -0.5856595, 0.3427131, 0.12878507, -0.0070874435, 0.11305926, 0.24937017, -0.14774731, -0.24084753, -0.26588252, 0.30411637, 0.16210328, 0.0504529, -0.49695018, 0.07644958, 0.00031846942, 0.11286356, 0.29244047, -0.51599264, 0.053249013, -0.04208358, 0.21338339, 0.20537174, 0.009326334, -0.18027069, -0.5352547, 0.2142151},
{-0.22390905, 0.0062465784, 0.17549782, 0.036147673, -0.4304799, -0.13772467, -0.4228316, 0.0017054795, 0.4111264, 0.08671394, 0.18257584, -0.03618599, -0.07287304, 0.12019494, -0.2332476, 0.42503357, 0.36862144, 0.11367377, -0.41615805, 0.060435433, 0.0827388, -0.010355497, 0.12552515, -0.30174989, 0.16690895, 0.16074327, 0.041354235, 0.266403, 0.19146158, -0.00034424482, -0.22838825, 0.27225184},
{0.3284967, -0.63982505, 0.24990088, 0.04840199, 0.13471109, 0.18471931, 0.06345376, -0.029882455, 0.38642457, -0.35664797, -0.23161887, 0.25155273, -0.33781478, 0.11559182, 0.17166461, 0.3393086, -0.41496372, -0.28319395, 0.20827664, 0.52323484, 0.2680708, -0.2502423, -0.1923188, -0.5221237, -0.20787838, 0.5227437, -0.3779879, 0.35207808, 0.37268537, 0.034991633, -0.20030215, -0.08301233},
{0.09915775, 0.08426822, 0.14155422, -0.037294537, -0.08760835, -0.03162019, -0.11972719, 0.13074648, 0.3758162, -0.012789152, 0.07700677, -0.36934882, -0.1517368, 0.017660573, 0.19769153, 0.26199788, 0.056593034, 0.15214327, 0.037862852, 0.56760263, 0.31652996, -0.014184253, 0.036632176, -0.40033206, -0.22831807, 0.059971616, -0.11513924, 0.141272, -0.07887173, 0.37401012, -0.43042168, -0.119308114},
{-0.31663373, -0.4499398, 0.3127342, -0.3277171, -0.17851691, -0.17823066, 0.0704771, 0.13032566, 0.2642897, -0.3318201, 0.11533924, 1.0899688, -0.109140806, -0.027497776, -0.37376687, 0.027426306, -0.16755278, 0.31907246, 0.19080569, -0.48056298, -0.22073819, -0.33459234, -0.19347984, 0.1819435, 0.12499693, -0.08911689, -0.08963683, -0.104482785, -0.16985756, -1.174981, 0.059559382, 0.19568586},
{0.030234799, -0.32236803, -0.03195762, -0.20206217, -0.10437345, 0.0046402887, 0.4923966, -0.018359212, 0.04491963, -0.08612605, -0.1062772, 0.25162688, 0.03348317, 0.14360137, 0.31070688, -0.113367565, -0.005580934, 0.09526385, 0.12161204, -0.36944875, -0.07932944, -0.035219647, 0.21515127, 0.08153463, 0.30515638, -0.17953467, -0.2023972, -0.56726885, -0.010038174, -0.46817932, 0.30812377, 0.3868891},
{0.34055096, 0.18650454, -0.12529159, -0.104357064, 0.28592268, 0.054123696, 0.5409499, -0.28564078, 0.34521523, 0.05957375, -0.24278164, -0.05206293, 0.34680983, -0.09762567, 0.009686424, -0.24337277, 0.18324666, -0.25299948, -0.12131763, 0.08106499, 0.022427797, 0.36552352, 0.09121923, 0.14174514, 0.14586589, -0.19048889, 0.09550782, -0.1933837, -0.0732798, -0.16245909, 0.39602065, 0.25171512},
{-0.4039693, -0.18438573, -0.032215327, 0.17028001, -0.14700565, -0.15194409, -0.11140235, 0.22449657, 0.39932138, -0.13802299, 0.33438596, 0.37086132, -0.032790214, -0.06818702, -0.43797565, 0.013148159, 0.27641177, -0.15215483, -0.12349297, -0.22585404, -0.07699574, -0.24544029, -0.27075016, 0.08175052, -0.06431642, -0.29231927, 0.12769477, 0.35348013, 0.10486864, -0.11450095, 0.4630703, 0.123476595},
{-0.0011876884, 0.23614421, -0.10329991, -0.30106208, 0.001704852, 0.20731215, 0.04108563, -0.032932658, 0.19001412, 0.25061268, 0.07816471, -0.04836019, 0.11617547, -0.33521077, -0.21672419, -0.09948944, 0.1807001, -8.829841e-05, -0.28635165, 0.060744815, -0.17171784, 0.2393919, 0.2699592, -0.06824164, 0.20103097, -0.08126098, 0.16534534, -0.06630505, -0.22730744, -0.110634655, -0.066971175, 0.13232929},
{0.3302541, 0.117788695, 0.008289994, -0.09800427, -0.16427596, 0.13335405, 0.26625767, 0.35632864, -0.081296034, 0.2373058, -0.33221608, -0.117064215, 0.27775916, -0.20013116, 0.57370996, -0.18810464, -0.10317635, -0.16389132, 0.048868205, -0.12057237, 0.21263254, 0.27631593, 0.08191319, -0.11983187, 0.40374866, -0.3454654, -0.012546637, -0.38431686, -0.3338233, -0.024931079, -0.017076487, 0.29086336},
{0.06697655, -0.34262347, -0.24236175, 0.31209162, 0.20165361, -0.029233882, 0.12308153, 0.12129853, -0.057085484, -0.02233004, -0.34029987, 0.12629864, 0.16591145, -0.06361068, 0.4137912, -0.087748535, -0.297633, -0.1220528, 0.05275212, 0.24437182, 0.22005095, -0.17889223, 0.14138356, -0.1750272, -0.32606727, -0.09862795, -0.17498916, -0.032383632, 0.06108431, -0.3110085, -0.1958938, -0.19122753},
{-0.050114505, -0.089516774, -0.075607814, -0.07677159, 0.1539295, -0.041915283, 0.42373088, -0.023647748, -0.20750251, 0.026597502, -0.028521234, 0.37833956, 0.019071173, 0.07037048, -0.22666244, -0.085057355, -0.26284477, -0.032465767, 0.3240359, -0.49989268, -0.32096836, 0.13557608, 0.0545584, 0.42618883, -0.23683728, -0.2956884, 0.16328883, 0.033311963, 0.10308393, -0.13334516, -0.0070570596, -0.36700544},
{0.1802545, 0.08926214, 0.015436303, 0.4270475, -0.10117364, 0.06631531, -0.28927907, 0.3352658, 0.21561527, 0.10463767, 0.1134823, -0.060118876, 0.09639646, -0.14225745, 0.21189894, 0.032436337, 0.103147976, 0.061155546, 0.0044489233, 0.28337917, 0.3176199, 0.047749024, -0.4173597, -0.057761963, -0.29849634, 0.118272245, -0.019731404, 0.5555219, 0.087541424, 0.14386295, -0.2023393, 0.041059278},
{0.12260983, -0.5069817, 0.26218015, -0.0076567433, -0.10820593, -0.1932014, -0.3705344, 0.08096028, 0.17384332, 0.13952814, -0.09704784, 0.17175609, -0.012822906, 0.0043785237, -0.2336469, 0.43455285, 0.30192614, 0.10665267, 0.057219263, 0.518746, -0.041452043, -0.000811088, -0.34935197, -0.2644239, -0.11695087, 0.053458206, 0.082406305, -0.32977062, 0.074233465, -0.47405472, -0.32563245, -0.21303368},
{0.13104184, -0.1366083, -0.395722, 0.31264943, 0.17137115, -0.05790066, 0.017633345, -0.14471336, -0.17566141, -0.024092598, 0.16145347, -0.17656459, -0.3461866, 0.44672748, 0.24636851, 0.106475495, -0.017960418, -0.042787842, 0.54556495, 0.002396034, 0.1658147, 0.10019334, -0.5381876, -0.18806796, -0.2236215, -0.101512276, -0.118669055, 0.22791477, 0.1350729, 0.15191618, 0.17866349, -0.18908511},
{0.26755375, -0.06919008, -0.30475312, -0.1953132, 0.3872827, 0.19956082, 0.118991904, -0.25415143, -0.4187607, -0.13477255, -0.18897504, 0.034967866, -0.022547072, 0.07344838, 0.17432685, 0.096230105, -0.2051744, 0.19947514, 0.27492803, 0.12897515, 0.20996217, 0.026479052, 0.02836784, 0.050024062, -0.3382002, -0.111309275, -0.23339626, -0.06425619, 0.0733682, -0.026581509, -0.096249625, -0.38249752},
{0.29463792, -0.33282748, -0.19182827, -0.3532589, 0.21260192, -0.39249924, -0.015239578, 0.14629747, -0.042410098, -0.32695085, -0.17577462, 1.0217041, -0.3178329, 0.096872054, 0.5136788, -0.2246973, -0.30635023, 0.34103698, -0.135696, -0.403396, -0.08127711, -0.035384264, 0.47416136, 0.07789457, -0.1818931, 0.24632286, 0.19263521, 0.42894068, 0.36349538, -1.882001, -0.13334386, -0.046206318},
{-0.09454481, 0.1357271, -0.22797967, 0.12591985, -0.13442592, -0.05991266, 0.06996157, 0.61132824, -0.11304385, -0.26616386, 0.077139676, -1.19892, 0.2995233, -0.20332378, -0.41260546, -0.28019327, 0.1884755, -0.04763437, -0.29291883, 0.08346682, 0.046275273, -0.18509011, -0.2536414, -0.060752843, 0.19794713, -0.14687553, 0.5672844, 0.09673406, -0.08128257, 1.4906754, 0.2671562, 0.3248379},
{-0.3802937, 0.076986544, -0.11544381, 0.05835499, -0.0023529965, -0.021430233, -0.22311306, -0.1957839, 0.12528215, 0.07691677, 0.57239085, -0.23229669, -0.023019623, -0.011913045, -0.7282962, 0.02723738, 0.102860145, 0.009850219, 0.15426503, -0.039351035, -0.36256987, -0.1352561, -0.060648654, -0.29077423, -0.019296035, 0.023092, 0.20567444, -0.2340969, 0.4741432, 0.5307464, 0.109004416, 0.017404424},};
static const float layer_3_weight[32][4] = {{-0.26771408, 0.34614843, -0.09583079, -0.13921416}, {-0.13538438, 0.29195035, -0.34895957, 0.2818731}, {-0.11219758, 0.07617371, 0.49536762, -0.28831097}, {-0.14805686, -0.38898656, 0.11895707, -0.16919135}, {-0.12532468, -0.34037364, -0.5701401, 0.010057757}, {-0.036962613, -0.368009, -0.1441014, 0.31922278}, {-0.02158684, 0.62719226, -0.42540398, 0.040680066}, {-0.13464952, 0.41432947, 0.24753337, -0.2962234}, {-0.079381645, -0.083259836, 0.88471323, 0.032307893}, {0.20662656, 0.35538542, 0.260111, 0.23385361}, {0.16962261, -0.38460854, 0.24135357, 0.29145426}, {-0.05271462, -0.05518829, 0.018803913, -0.5307863}, {-0.24039143, 0.10700162, -0.21776277, -0.30266574}, {0.22159828, -0.21411443, -0.23617749, 0.16278026}, {-0.32728904, 0.34315988, -0.107138, -0.5720437}, {-0.022767438, -0.3549766, 0.32565585, 0.2908243}, {-0.027819358, 0.35364398, 0.47755817, 0.03354847}, {0.03370494, -0.018754426, 0.34875864, -0.1452214}, {0.16717538, -0.2928559, -0.56162167, 0.28333}, {-0.16988394, -0.0864116, 0.47829977, 0.1450765}, {-0.31358293, -0.010724641, 0.18671818, -0.16575925}, {-0.24574368, 0.23974971, -0.03270094, 0.2003122}, {0.032357875, 0.37532523, -0.35469267, 0.11248902}, {0.025954783, -0.0031184293, -0.5313034, -0.4206669}, {0.3130483, 0.63294035, 0.40504888, 0.26302403}, {0.12642437, -0.2888529, 0.5486983, -0.07555652}, {-0.019483928, 0.49147648, 0.25285062, -0.21323945}, {-0.32503268, -0.27851224, -0.1941583, -0.45771948}, {0.08422547, -0.73274666, -0.09298538, -0.19093414}, {0.08277721, -0.028541403, 0.015202023, 0.85713553}, {0.17075373, 0.3057736, -0.16739103, -0.18225004}, {0.0039858297, 0.5453555, 0.61297953, 0.035162758}};
static const float residual_layer_bias[4] = {1.9067034, -0.023829473, -0.02225955, -0.20003872};
static const float layer_0_bias[32] = {-0.096199974,	0.46254915,	-0.047995128,	0.30127627,	-0.18409926,	0.2681884,	0.011576709,	0.050392248,	0.28733942,	-0.13751087,	0.13041897,	0.065861315,	0.6422262,	-0.031604506,	0.19306107,	0.45348755,	0.0017263639,	-0.0819036,	0.004662854,	0.0012119208,	0.61500317,	0.059447065,	0.27690047,	-0.16462024,	0.27384314,	0.1074836,	0.23660065,	0.10679779,	-0.09040273,	-0.4699522,	0.02144852,	0.07797744};
static const float layer_1_bias[32] = {-0.07412166,	-0.1471114,	0.16071226,	-0.20760258,	0.17145503,	-0.007603161,	0.2383447,	-0.2014593,	0.12152405,	0.0154490685,	-0.07654682,	-0.06564316,	-0.08993539,	-0.24875943,	-0.079239644,	-0.19262254,	-0.002710316,	0.20960772,	0.08966788,	-0.14199044,	0.14962606,	-0.03244135,	-0.22798859,	-0.078475274,	-0.0032402063,	0.120417185,	0.28347498,	0.11251397,	0.19500253,	-0.043937787,	-0.1419527,	0.21368678};
static const float layer_2_bias[32] = {-0.17482623,	-0.20483145,	-0.1764139,	-0.2659333,	-0.17702046,	0.11986595,	0.04146523,	-0.19304329,	0.019165441,	-0.08247727,	0.16429333,	0.040048018,	-0.034080297,	0.20665051,	-0.13682048,	-0.058441903,	-0.11516748,	-0.062207248,	0.16012229,	0.03585209,	0.121854894,	-0.08217975,	0.09119139,	0.040768564,	0.18735324,	-0.13294199,	-0.07496764,	-0.38645685,	-0.115099534,	0.026518641,	0.19820698,	-0.1486478};
static const float layer_3_bias[4] = {0.0941731,-0.07689924,-0.1150862,0.11339472};


// Helper functions
static struct vec state2vec(struct vec3_s v)
{
  return mkvec(v.x, v.y, v.z);
}

bool isInGroup(uint8_t g) {
  return g == ALL_GROUPS || (g & group_mask) != 0;
}

bool crtpCommanderHighLevelMatchesGroupMask(uint8_t g) {
  return g == ALL_GROUPS || (g & group_mask) != 0;
}

void crtpCommanderHighLevelInit(void)
{
  if (isInit) {
    return;
  }

  memoryRegisterHandler(&memDef);
  plan_init(&planner);

  //Start the trajectory task
  STATIC_MEM_TASK_CREATE(crtpCommanderHighLevelTask, crtpCommanderHighLevelTask, CMD_HIGH_LEVEL_TASK_NAME, NULL, CMD_HIGH_LEVEL_TASK_PRI);

  lockTraj = xSemaphoreCreateMutexStatic(&lockTrajBuffer);

  pos = vzero();
  vel = vzero();
  yaw = 0;

  isInit = true;
}

bool crtpCommanderHighLevelIsStopped()
{
  return plan_is_stopped(&planner);
}

void crtpCommanderHighLevelTellState(const state_t *state)
{
  xSemaphoreTake(lockTraj, portMAX_DELAY);
  pos = state2vec(state->position);
  vel = state2vec(state->velocity);
  yaw = radians(state->attitude.yaw);
  xSemaphoreGive(lockTraj);
}

int crtpCommanderHighLevelDisable()
{
  plan_disable(&planner);
  return 0;
}

float lrelu(float x)
{
  return (x > 0) ? x : 0.01f*x;
}

float hard_tanh(float x)
{
  if (x > 1) 
  {
      return 1.0f;
  } 
  else if (x < -1) 
  {
      return -1.0f;
  } 
  else 
  {
      return x;
  }
}


static void runNeuralNetwork(setpoint_t* setpoint, velocity_t V, quaternion_t q, point_t* p) {

  // TODO
  float state_array[22] = {V.x, V.y, V.z, q.w, q.x, q.y, q.z,
   0, 0, 0, // p1
   0, 0, 0, // p2
   0, 0, 0, // p3
   0, 0, 0, // p4
   0, 0, 0}; // p5
  

  // input layer 22->32
  for (int i = 0; i < structure[0][1]; i++) {
			output_0[i] = 0;
			for (int j = 0; j < structure[0][0]; j++) {
				output_0[i] += state_array[j] * layer_0_weight[j][i];
			}
			output_0[i] += layer_0_bias[i];
			output_0[i] = lrelu(output_0[i]);
		}
	
  // residual layer 22->4
	for (int i = 0; i < structure[1][1]; i++) {
			output_residual[i] = 0;
			for (int j = 0; j < structure[1][0]; j++) {
				output_residual[i] += state_array[j] * residual_layer_weight[j][i];
			}
			output_residual[i] += residual_layer_bias[i];
		}
  
  // 1st hidden layer 32->32
  for (int i = 0; i < structure[2][1]; i++) {
			output_1[i] = 0;
			for (int j = 0; j < structure[2][0]; j++) {
				output_1[i] += output_0[j] * layer_1_weight[j][i];
			}
			output_1[i] += layer_1_bias[i];
			output_1[i] = tanhf(output_1[i]);
		}

  // 2nd hidden layer 32->32
	for (int i = 0; i < structure[3][1]; i++) {
			output_2[i] = 0;
			for (int j = 0; j < structure[3][0]; j++) {
				output_2[i] += output_1[j] * layer_2_weight[j][i];
			}
			output_2[i] += layer_2_bias[i];
      output_2[i] = tanhf(output_2[i]);
		}
  
  // output layer 32->4
	for (int i = 0; i < structure[4][1]; i++) {
			output_3[i] = 0;
			for (int j = 0; j < structure[4][0]; j++) {
				output_3[i] += output_2[j] * layer_3_weight[j][i];
			}
			output_3[i] += layer_3_bias[i];
      output_3[i] = hard_tanh(output_3[i]);
		}
		
		setpoint->thrust = output_3[0] + output_residual[0];
		setpoint->attitudeRate.roll = output_3[1] + output_residual[1];
		setpoint->attitudeRate.pitch = output_3[2] + output_residual[2];
		setpoint->attitudeRate.yaw = output_3[3] + output_residual[3];
}

static struct traj_eval evalAtParam(float pathParam) {
  	int cursor = 0;
    const struct piecewise_traj *traj = planner.trajectory;
    while (cursor < traj->n_pieces) {
      struct poly4d const *piece = &(traj->pieces[cursor]);
      if (pathParam <= piece->duration * traj->timescale) {
        return poly4d_eval(piece, pathParam);
      }
      pathParam -= piece->duration * traj->timescale;
      ++cursor;
    }
    // if we get here, the trajectory has ended
    struct poly4d const *end_piece = &(traj->pieces[traj->n_pieces - 1]);
    struct traj_eval ev = poly4d_eval(end_piece, end_piece->duration);
    ev.pos = vadd(ev.pos, traj->shift);
    ev.vel = vzero();
    ev.acc = vzero();
    ev.omega = vzero();
    return ev;
}

static point_t getTrajPoint(float pathParam) {
  // In piecewise_eval, it is presumed that the second argument is the actual time,
  // and so traj->t_begin will be substracted from it. We're not using time here,
  // but rather a path parameter, which begins from 0, so instead of pathParam,
  // we pass pathParam+time. Might want to make our own function maybe to avoid this.
  struct traj_eval ev;
  if (planner.type == TRAJECTORY_TYPE_PIECEWISE) { // only non-compressed for now
    ev = evalAtParam(pathParam);
  } else {
    ev = traj_eval_invalid();
  }
  point_t p = {ev.pos.x, ev.pos.y, ev.pos.z};
  return p;
}

static float distanceSquare(const state_t *state, float pathParam) {
    point_t currentPoint = state->position;
    point_t pointAtParam = getTrajPoint(pathParam);
    float dx = currentPoint.x - pointAtParam.x;
    float dy = currentPoint.y - pointAtParam.y;
    float dz = currentPoint.z - pointAtParam.z;
    return dx*dx + dy*dy + dz*dz;
  }

static float getClosestPathParam(const state_t *state, const float prevParam, const float maxParam) {
  int n = 50;
  float delta = (maxParam - prevParam) / n;
  float closestParam = prevParam;
  float runningParam = prevParam;
  float mind2 = distanceSquare(state, prevParam);  
  float d2 = distanceSquare(state, runningParam);  
  for (int i=1; i<50; i++) {
    runningParam += delta;
    d2 = distanceSquare(state, runningParam);  
    if (d2 < mind2) {
      mind2 = d2;
      closestParam = runningParam;
    }
  }
  return closestParam;
} 

float reachableParameter(const state_t *state, float currentPathParam) {
  //velocity_t vel = state->velocity;
  //float speed = sqrt(pow(vel.x, 2) + pow(vel.y, 2) + pow(vel.z, 2));
  struct vec vel = state2vec(state->velocity);
  float speed = vmag(vel);
  speed = (speed < 2.0f) ? speed : 2.0f;
  speed = (speed > 1.25f) ? speed : 1.25f;
  float reachable = currentPathParam + 30*speed* 0.05f; // dt = 0.05
  return reachable; // TODO
}

static float currentParam = 0;

void mpcGetSetpoint(setpoint_t* setpoint, const state_t *state, uint32_t tick) {
  // should set the setpoint to be used for the attitude rate control:
  // project position onto reference -> get closes path reference
  // determine sampled points (evenly spaced between current path reference and reachable)
  // run neural network -> angular velocity and thrust can be set in setpoint
  if (usecTimestamp() / 1e6f <= planner.trajectory -> t_begin + 0.1f) {
    currentParam = 0;
  } 
  currentParam = getClosestPathParam(state, currentParam, currentParam+0.05f*3);
  float d = (reachableParameter(state, currentParam) - currentParam)/6; // path param diff between points
  point_t points[5];
  if (planner.type == TRAJECTORY_TYPE_PIECEWISE) { // only non-compressed for now
    for (int i=1; i<6; i++) {
      float pathParam = currentParam + (i+1)*d;
      point_t posAtParam = getTrajPoint(pathParam);
      point_t pos = state->position;
      points[i-1].x = posAtParam.x - pos.x;
      points[i-1].y = posAtParam.y - pos.y;
      points[i-1].z = posAtParam.z - pos.z;
    }
    runNeuralNetwork(setpoint, state->velocity, state->attitudeQuaternion, points);
  }
}

bool crtpCommanderHighLevelGetSetpoint(setpoint_t* setpoint, const state_t *state, uint32_t tick)
{
  if (!RATE_DO_EXECUTE(RATE_HL_COMMANDER, tick)) {
    return false;
  }

  xSemaphoreTake(lockTraj, portMAX_DELAY);
  float t = usecTimestamp() / 1e6;
  struct traj_eval ev = plan_current_goal(&planner, t);
  xSemaphoreGive(lockTraj);

  // If we are not actively following a trajectory, then update the "last
  // setpoint" values with the current state estimate, so we have the right
  // initial conditions for future trajectory planning.
  if (plan_is_disabled(&planner) || plan_is_stopped(&planner)) {
    pos = state2vec(state->position);
    vel = state2vec(state->velocity);
    yaw = radians(state->attitude.yaw);
    if (plan_is_stopped(&planner)) {
      // Return a null setpoint - when the HLcommander is stopped, it wants the
      // motors to be off. Only reason they should be spinning is if the
      // HLcommander has been preempted by a streaming setpoint command.
      *setpoint = nullSetpoint;
      return true;
    }
    // Otherwise, do not mutate the setpoint.
    return false;
  }
  else if (is_traj_eval_valid(&ev)) {
    setpoint->position.x = ev.pos.x;
    setpoint->position.y = ev.pos.y;
    setpoint->position.z = ev.pos.z;
    setpoint->velocity.x = ev.vel.x;
    setpoint->velocity.y = ev.vel.y;
    setpoint->velocity.z = ev.vel.z;
    setpoint->attitude.roll = degrees(ev.rpy.x);
    setpoint->attitude.pitch = degrees(ev.rpy.y);
    setpoint->attitude.yaw = degrees(ev.yaw);
    setpoint->attitudeRate.roll = degrees(ev.omega.x);
    setpoint->attitudeRate.pitch = degrees(ev.omega.y);
    setpoint->attitudeRate.yaw = degrees(ev.omega.z);
    setpoint->thrust = ev.thrust;
    setpoint->torques.x = ev.torques.x;
    setpoint->torques.y = ev.torques.y;
    setpoint->torques.z = ev.torques.z;
    setpoint->mode.x = modeAbs;
    setpoint->mode.y = modeAbs;
    setpoint->mode.z = modeAbs;
    setpoint->mode.roll = modeDisable;
    setpoint->mode.pitch = modeDisable;
    setpoint->mode.yaw = modeAbs;
    setpoint->mode.quat = modeDisable;
    setpoint->acceleration.x = ev.acc.x;
    setpoint->acceleration.y = ev.acc.y;
    setpoint->acceleration.z = ev.acc.z;
    setpoint->t_traj = (uint32_t)((t - planner.trajectory->t_begin) * 1000);
    // store the last setpoint
    pos = ev.pos;
    vel = ev.vel;
    yaw = ev.yaw;

    return true;
  }
  else {
    // Not disabled or stopped but invalid eval indicates a programming error.
    plan_disable(&planner);
    return false;
  }
}

static int handleCommand(const enum TrajectoryCommand_e command, const uint8_t* data)
{
  int ret = 0;

  switch(command)
  {
    case COMMAND_SET_GROUP_MASK:
      ret = set_group_mask((const struct data_set_group_mask*)data);
      break;
    case COMMAND_TAKEOFF:
      ret = takeoff((const struct data_takeoff*)data);
      break;
    case COMMAND_LAND:
      ret = land((const struct data_land*)data);
      break;
    case COMMAND_TAKEOFF_2:
      ret = takeoff2((const struct data_takeoff_2*)data);
      break;
    case COMMAND_LAND_2:
      ret = land2((const struct data_land_2*)data);
      break;
    case COMMAND_TAKEOFF_WITH_VELOCITY:
      ret = takeoff_with_velocity((const struct data_takeoff_with_velocity*)data);
      break;
    case COMMAND_LAND_WITH_VELOCITY:
      ret = land_with_velocity((const struct data_land_with_velocity*)data);
      break;
    case COMMAND_STOP:
      ret = stop((const struct data_stop*)data);
      break;
    case COMMAND_GO_TO:
      ret = go_to((const struct data_go_to*)data);
      break;
    case COMMAND_START_TRAJECTORY:
      ret = start_trajectory((const struct data_start_trajectory*)data, 0);
      break;
    case COMMAND_DEFINE_TRAJECTORY:
      ret = define_trajectory((const struct data_define_trajectory*)data);
      break;
    default:
      ret = ENOEXEC;
      break;
  }

  return ret;
}

void crtpCommanderHighLevelTask(void * prm)
{
  CRTPPacket p;
  crtpInitTaskQueue(CRTP_PORT_SETPOINT_HL);

  while(1) {
    crtpReceivePacketBlock(CRTP_PORT_SETPOINT_HL, &p);

    int ret = handleCommand(p.data[0], &p.data[1]);

    //answer
    p.data[3] = ret;
    p.size = 4;
    crtpSendPacketBlock(&p);
  }
}

int set_group_mask(const struct data_set_group_mask* data)
{
  group_mask = data->groupMask;

  return 0;
}

// Deprecated (removed after August 2023)
int takeoff(const struct data_takeoff* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;
    result = plan_takeoff(&planner, pos, yaw, data->height, 0.0f, data->duration, t);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int takeoff2(const struct data_takeoff_2* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;

    float hover_yaw = data->yaw;
    if (data->useCurrentYaw) {
      hover_yaw = yaw;
    }

    result = plan_takeoff(&planner, pos, yaw, data->height, hover_yaw, data->duration, t);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int takeoff_with_velocity(const struct data_takeoff_with_velocity* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;

    float hover_yaw = data->yaw;
    if (data->useCurrentYaw) {
      hover_yaw = yaw;
    }

    float height = data->height;
    if (data->heightIsRelative) {
      height += pos.z;
    }

    float velocity = data->velocity > 0 ? data->velocity : defaultTakeoffVelocity;
    float duration = fabsf(height - pos.z) / velocity;
    result = plan_takeoff(&planner, pos, yaw, height, hover_yaw, duration, t);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

// Deprecated (removed after August 2023)
int land(const struct data_land* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;
    result = plan_land(&planner, pos, yaw, data->height, 0.0f, data->duration, t);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int land2(const struct data_land_2* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;

    float hover_yaw = data->yaw;
    if (data->useCurrentYaw) {
      hover_yaw = yaw;
    }

    result = plan_land(&planner, pos, yaw, data->height, hover_yaw, data->duration, t);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int land_with_velocity(const struct data_land_with_velocity* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;

    float hover_yaw = data->yaw;
    if (data->useCurrentYaw) {
      hover_yaw = yaw;
    }

    float height = data->height;
    if (data->heightIsRelative) {
      height = pos.z - height;
    }

    float velocity = data->velocity > 0 ? data->velocity : defaultLandingVelocity;
    float duration = fabsf(height - pos.z) / velocity;
    result = plan_land(&planner, pos, yaw, height, hover_yaw, duration, t);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int stop(const struct data_stop* data)
{
  int result = 0;
  if (isInGroup(data->groupMask)) {
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    plan_stop(&planner);
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int go_to(const struct data_go_to* data)
{
  static struct traj_eval ev = {
    // pos, vel, yaw will be filled before using
    .acc = {0.0f, 0.0f, 0.0f},
    .omega = {0.0f, 0.0f, 0.0f},
  };

  int result = 0;
  if (isInGroup(data->groupMask)) {
    struct vec hover_pos = mkvec(data->x, data->y, data->z);
    xSemaphoreTake(lockTraj, portMAX_DELAY);
    float t = usecTimestamp() / 1e6;
    if (plan_is_disabled(&planner) || plan_is_stopped(&planner)) {
      ev.pos = pos;
      ev.vel = vel;
      ev.yaw = yaw;
      result = plan_go_to_from(&planner, &ev, data->relative, hover_pos, data->yaw, data->duration, t);
    }
    else {
      result = plan_go_to(&planner, data->relative, hover_pos, data->yaw, data->duration, t);
    }
    xSemaphoreGive(lockTraj);
  }
  return result;
}

int start_trajectory(const struct data_start_trajectory* data, float offset)
{
  int result = 0;
  if (offset < 0 || isnan(offset)) {
    return ENOEXEC;
  }
  if (isInGroup(data->groupMask)) {
    if (data->trajectoryId < NUM_TRAJECTORY_DEFINITIONS) {
      struct trajectoryDescription* trajDesc = &trajectory_descriptions[data->trajectoryId];
      if (   trajDesc->trajectoryLocation == TRAJECTORY_LOCATION_MEM
          && trajDesc->trajectoryType == CRTP_CHL_TRAJECTORY_TYPE_POLY4D) {
        xSemaphoreTake(lockTraj, portMAX_DELAY);
        float t = usecTimestamp() / 1e6f - offset;
        trajectory.t_begin = t;
        trajectory.timescale = data->timescale;
        trajectory.n_pieces = trajDesc->trajectoryIdentifier.mem.n_pieces;
        trajectory.pieces = (struct poly4d*)&trajectories_memory[trajDesc->trajectoryIdentifier.mem.offset];
        result = plan_start_trajectory(&planner, &trajectory, data->reversed, data->relative, pos);
        xSemaphoreGive(lockTraj);
      } else if (trajDesc->trajectoryLocation == TRAJECTORY_LOCATION_MEM
          && trajDesc->trajectoryType == CRTP_CHL_TRAJECTORY_TYPE_POLY4D_COMPRESSED) {

        if (data->timescale != 1 || data->reversed) {
          result = ENOEXEC;
        } else {
          xSemaphoreTake(lockTraj, portMAX_DELAY);
          float t = usecTimestamp() / 1e6f - offset;
          piecewise_compressed_load(
            &compressed_trajectory,
            &trajectories_memory[trajDesc->trajectoryIdentifier.mem.offset]
          );
          compressed_trajectory.t_begin = t;
          result = plan_start_compressed_trajectory(&planner, &compressed_trajectory, data->relative, pos);
          xSemaphoreGive(lockTraj);
        }

      }
    }
  }
  return result;
}

int define_trajectory(const struct data_define_trajectory* data)
{
  if (data->trajectoryId >= NUM_TRAJECTORY_DEFINITIONS || data->description.trajectoryIdentifier.mem.offset % 4) {
    return ENOEXEC;
  }
  trajectory_descriptions[data->trajectoryId] = data->description;
  return 0;
}

static bool handleMemRead(const uint32_t memAddr, const uint8_t readLen, uint8_t* buffer) {
  return crtpCommanderHighLevelReadTrajectory(memAddr, readLen, buffer);
}

static bool handleMemWrite(const uint32_t memAddr, const uint8_t writeLen, const uint8_t* buffer) {
  return crtpCommanderHighLevelWriteTrajectory(memAddr, writeLen, buffer);
}

uint8_t* initCrtpPacket(CRTPPacket* packet, const enum TrajectoryCommand_e command)
{
  packet->port = CRTP_PORT_SETPOINT_HL;
  packet->data[0] = command;
  return &packet->data[1];
}

int crtpCommanderHighLevelTakeoff(const float absoluteHeight_m, const float duration_s)
{
  struct data_takeoff_2 data =
  {
    .height = absoluteHeight_m,
    .duration = duration_s,
    .useCurrentYaw = true,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_TAKEOFF_2, (const uint8_t*)&data);
}

int crtpCommanderHighLevelTakeoffYaw(const float absoluteHeight_m, const float duration_s, const float yaw)
{
  struct data_takeoff_2 data =
  {
    .height = absoluteHeight_m,
    .duration = duration_s,
    .useCurrentYaw = false,
    .yaw = yaw,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_TAKEOFF_2, (const uint8_t*)&data);
}

int crtpCommanderHighLevelTakeoffWithVelocity(const float height_m, const float velocity_m_s, bool relative)
{
  struct data_takeoff_with_velocity data =
  {
    .height = height_m,
    .heightIsRelative = relative,
    .velocity = velocity_m_s,
    .useCurrentYaw = true,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_TAKEOFF_WITH_VELOCITY, (const uint8_t*)&data);
}

int crtpCommanderHighLevelLand(const float absoluteHeight_m, const float duration_s)
{
  struct data_land_2 data =
  {
    .height = absoluteHeight_m,
    .duration = duration_s,
    .useCurrentYaw = true,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_LAND_2, (const uint8_t*)&data);
}

int crtpCommanderHighLevelLandWithVelocity(const float height_m, const float velocity_m_s, bool relative)
{
  struct data_land_with_velocity data =
  {
    .height = height_m,
    .heightIsRelative = relative,
    .velocity = velocity_m_s,
    .useCurrentYaw = true,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_LAND_WITH_VELOCITY, (const uint8_t*)&data);
}

int crtpCommanderHighLevelLandYaw(const float absoluteHeight_m, const float duration_s, const float yaw)
{
  struct data_land_2 data =
  {
    .height = absoluteHeight_m,
    .duration = duration_s,
    .useCurrentYaw = false,
    .yaw = yaw,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_LAND_2, (const uint8_t*)&data);
}

int crtpCommanderHighLevelStop()
{
  struct data_stop data =
  {
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_STOP, (const uint8_t*)&data);
}

int crtpCommanderHighLevelGoTo(const float x, const float y, const float z, const float yaw, const float duration_s, const bool relative)
{
  struct data_go_to data =
  {
    .x = x,
    .y = y,
    .z = z,
    .yaw = yaw,
    .duration = duration_s,
    .relative = relative,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_GO_TO, (const uint8_t*)&data);
}

bool crtpCommanderHighLevelIsTrajectoryDefined(uint8_t trajectoryId)
{
  return (
    trajectoryId < NUM_TRAJECTORY_DEFINITIONS &&
    trajectory_descriptions[trajectoryId].trajectoryLocation != TRAJECTORY_LOCATION_INVALID
  );
}

int crtpCommanderHighLevelStartTrajectory(const uint8_t trajectoryId, const float timeScale, const bool relative, const bool reversed)
{
  struct data_start_trajectory data =
  {
    .trajectoryId = trajectoryId,
    .timescale = timeScale,
    .relative = relative,
    .reversed = reversed,
    .groupMask = ALL_GROUPS,
  };

  return handleCommand(COMMAND_START_TRAJECTORY, (const uint8_t*)&data);
}

int crtpCommanderHighLevelStartTrajectoryWithOffset(const uint8_t trajectoryId, const float offset, const float timeScale, const bool relative, const bool reversed)
{
  struct data_start_trajectory data =
  {
    .trajectoryId = trajectoryId,
    .timescale = timeScale,
    .relative = relative,
    .reversed = reversed,
    .groupMask = ALL_GROUPS,
  };

  return start_trajectory(&data, offset);
}

int crtpCommanderHighLevelDefineTrajectory(const uint8_t trajectoryId, const crtpCommanderTrajectoryType_t type, const uint32_t offset, const uint8_t nPieces)
{
  struct data_define_trajectory data =
  {
    .trajectoryId = trajectoryId,
    .description.trajectoryLocation = TRAJECTORY_LOCATION_MEM,
    .description.trajectoryType = type,
    .description.trajectoryIdentifier.mem.offset = offset,
    .description.trajectoryIdentifier.mem.n_pieces = nPieces,
  };

  return handleCommand(COMMAND_DEFINE_TRAJECTORY, (const uint8_t*)&data);
}

uint32_t crtpCommanderHighLevelTrajectoryMemSize()
{
  return sizeof(trajectories_memory);
}

bool crtpCommanderHighLevelWriteTrajectory(const uint32_t offset, const uint32_t length, const uint8_t* data)
{
  bool result = false;

  if ((offset + length) <= sizeof(trajectories_memory)) {
    memcpy(&(trajectories_memory[offset]), data, length);
    result = true;
  }

  return result;
}

bool crtpCommanderHighLevelReadTrajectory(const uint32_t offset, const uint32_t length, uint8_t* destination)
{
  bool result = false;

  if (offset + length <= sizeof(trajectories_memory) && memcpy(destination, &(trajectories_memory[offset]), length)) {
    result = true;
  }

  return result;
}

bool crtpCommanderHighLevelIsTrajectoryFinished() {
  float t = usecTimestamp() / 1e6;
  return plan_is_finished(&planner, t);
}

/**
 * computes smooth setpoints based on high-level inputs such as: take-off,
 * landing, polynomial trajectories.
 */
PARAM_GROUP_START(hlCommander)

/**
 * @brief Default take off velocity (m/s)
 */
PARAM_ADD_CORE(PARAM_FLOAT, vtoff, &defaultTakeoffVelocity)

/**
 * @brief Default landing velocity (m/s)
 */
PARAM_ADD_CORE(PARAM_FLOAT, vland, &defaultLandingVelocity)

PARAM_GROUP_STOP(hlCommander)